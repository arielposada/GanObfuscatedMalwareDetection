<h1 id="Gan-Obfuscated-Malware-Detection">Gan Obfuscated Malware Detection</h1>
<p>Code associated to the conference: Using Generative Adversarial Networks (GAN) to detect Cyber Threats</p>

<h1 id="QUICK-START-GUIDE">QUICK START GUIDE</h1>
<p>Before executing this project you have to consider the data flow of the solution, so you may decide what component(s) you desire to execute. In the data flow shown below we may identify different components which have the following functionality:</p>
<ol>
<li>Entropy tester : This classifier detects if a sample is or not obfuscated</li>
<li>Image Transformer : This module converts a sample to image</li>
<li>Not Encoded Classifier : This classfier is able to detect if a non encoded sample is Goodware or Malware</li>
<li>Shikata Ga Nai / XOR Classifier : This classifier is able to detect if a Shikata Ga Nai / XOR encoded sample is is Goodware or Malware</li>
</ol>
<p>You may decide to test each one of the modules that compose the flow or go directly to the deployed web application version.</p>

![Flow](misc/images_readme/flow.png)

## 1. Detecting obfuscation (Entropy Tester)

The python code to identify whether a binary file has been obfuscated (XOR/Shikata ga nai) can be found in the notebook `misc/entropy_tester/entropy_tester.ipynb`. In the cell named *Create and write entropy data*, the entropies for every file in the folders indicated by the user (in this case, the folders containing the samples from the previous section) are extracted and saved in a file named `entropies.csv`, which can be found in the `misc/entropy_tester` folder. Then, the cell named *Read entropy data* reads the CSV file. The remaining cells in the notebook test the performance of several machine learning algorithms when identifying obfuscated binary files based on its entropy.



## 2. Obtaining the images (Images Transformer)

The script `misc/binary2image.py` transforms executable files into greyscale images, as described in the paper. The script can be used with `python binary2image.py input_folder output_folder`, where `input_folder` contains the binary files and `output_folder` will contain the resulting images.

If you want to test by yourself the conversion from a goodware binary to images, you may use the python script binary2image.py, as shown in the image below, where is being applied over a folder that contains a a goodware file (zotero) in different versions: not obfuscated, XOR obfuscated and Shikata Ga Nai obfuscated

<center>
<figure>
    <img src="misc/images_readme/zotero_all_versions.png" width="40%" height="40%">
    <figcaption>Zotero in three versions: Not obfuscated, XOR obfuscated and Shikata Ga Nai obfuscated</figcaption>
</figure>
</center>

<center>
<figure>
    <img src="misc/images_readme/samples_binaries_goodware.png" width="80%" height="80%">
    <figcaption>Executing binary2image script to convert Zotero binaries to images</figcaption>
</figure>
</center>

<center>
<img src="misc/images_readme/zotero.png" width="20%" height="20%"><figcaption>Image obtained for Zotero no encoded </figcaption>
</center>

<center>
<img src="misc/images_readme/zoteroencoded_bloxor.png" width="20%" height="20%"><figcaption>Image obtained for Zotero encoded with bloxor</figcaption></center>


<center><img src="misc/images_readme/zoteroencoded_shikata.png" width="20%" height="20%"><figcaption>Image obtained for Zotero encoded with Shikata Ga Nai</figcaption></center>

We may do a similar test with a malware sample, as shown below:

<center>
<img src="misc/images_readme/samples_binaries_malware.png" width="40%" height="40%"><figcaption>Malware in three versions: Not obfuscated, XOR obfuscated and Shikata Ga Nai obfuscated</figcaption>
</center>

<center>
<figure>
    <img src="misc/images_readme/samples_binaries_malware_msfvenom.png" width="80%" height="80%">
    <figcaption>Executing binary2image script to convert malware binaries to images</figcaption>
</figure>
</center>


<center>
<img src="misc/images_readme/VirusShare_83c460e93694aad6cf15370bd50a2684.png" width="20%" height="20%"><figcaption>Image obtained for malware no encoded </figcaption>
</center>

<center>
<img src="misc/images_readme/virusencoded_bloxor.png" width="20%" height="20%"><figcaption>Image obtained for malware encoded with bloxor </figcaption>
</center>

<center>
<img src="misc/images_readme/virusencoded_shikata.png" width="20%" height="20%"><figcaption>Image obtained for malware encoded with Shikata Ga Nai </figcaption>
</center>


## 3. Detecting malware (Not Encoded Classifier and Shikata Ga nai / XOR Classifier)

The notebooks `nbs/non_obfuscated.ipynb` and `nbs/obfuscated.ipynb` read the images from the previous step and trains Generative Adversarial Network Models to dettect malware.

The files `server/python_test_resnet18_gan.py` and `server/python_test_resnet18_gan_obf.py` can be used for larger datasets.
